-- GGH Chat v4.0 - Рабочий синхронизированный чат без дублирования

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local Player = Players.LocalPlayer

-- Уникальный ID для этого сеанса чата
local SESSION_ID = HttpService:GenerateGUID(false):sub(1, 8)
local MY_ID = Player.UserId .. "_" .. SESSION_ID

-- Глобальная таблица для синхронизации (основная фишка)
if not _G.GGH_CHAT_GLOBAL then
    _G.GGH_CHAT_GLOBAL = {
        Players = {},      -- Игроки онлайн
        Messages = {},     -- Сообщения
        LastMessageId = 0, -- ID последнего сообщения
        Sessions = {}      -- Активные сессии
    }
end

-- Мои данные
_G.GGH_CHAT_GLOBAL.Sessions[MY_ID] = {
    PlayerName = Player.Name,
    Color = Color3.fromHSV(math.random(), 0.7, 0.9),
    LastPing = tick(),
    Active = true
}

local MyColor = _G.GGH_CHAT_GLOBAL.Sessions[MY_ID].Color

-- Только моя локальная таблица сообщений (чтобы не дублировались)
local MyMessages = {}
local ReceivedMessageIds = {} -- Для отслеживания уже полученных сообщений

-- Создаем GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GGH_Chat_" .. SESSION_ID
ScreenGui.Parent = game:GetService("CoreGui") or Player:WaitForChild("PlayerGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

-- Основной контейнер
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 20, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.65, 0, 0.25, 0)
MainFrame.Size = UDim2.new(0, 500, 0, 600)
MainFrame.Active = true
MainFrame.Draggable = true

-- Закругления
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

-- Верхняя панель
local TopBar = Instance.new("Frame")
TopBar.Name = "TopBar"
TopBar.Parent = MainFrame
TopBar.BackgroundColor3 = Color3.fromRGB(25, 35, 50)
TopBar.Size = UDim2.new(1, 0, 0, 50)

local TopBarCorner = Instance.new("UICorner")
TopBarCorner.CornerRadius = UDim.new(0, 12)
TopBarCorner.Parent = TopBar

-- Заголовок
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Parent = TopBar
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(0.7, 0, 1, 0)
Title.Position = UDim2.new(0.02, 0, 0, 0)
Title.Font = Enum.Font.GothamBold
Title.Text = "GGH CHAT v4.0"
Title.TextColor3 = Color3.fromRGB(0, 200, 255)
Title.TextSize = 18
Title.TextXAlignment = Enum.TextXAlignment.Left

local Status = Instance.new("TextLabel")
Status.Name = "Status"
Status.Parent = TopBar
Status.BackgroundTransparency = 1
Status.Size = UDim2.new(0.7, 0, 0.5, 0)
Status.Position = UDim2.new(0.02, 0, 0.5, 0)
Status.Font = Enum.Font.Gotham
Status.Text = "Connected • Players: 1"
Status.TextColor3 = Color3.fromRGB(150, 200, 255)
Status.TextSize = 12
Status.TextXAlignment = Enum.TextXAlignment.Left

-- Кнопки
local CloseBtn = Instance.new("TextButton")
CloseBtn.Name = "CloseBtn"
CloseBtn.Parent = TopBar
CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(0.95, -35, 0.5, -15)
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Text = "×"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 20
CloseBtn.AutoButtonColor = false

local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Name = "MinimizeBtn"
MinimizeBtn.Parent = TopBar
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(40, 50, 70)
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
MinimizeBtn.Position = UDim2.new(0.95, -70, 0.5, -15)
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.Text = "_"
MinimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeBtn.TextSize = 16
MinimizeBtn.AutoButtonColor = false

-- Основное содержимое
local Content = Instance.new("Frame")
Content.Name = "Content"
Content.Parent = MainFrame
Content.BackgroundTransparency = 1
Content.Position = UDim2.new(0, 10, 0, 60)
Content.Size = UDim2.new(1, -20, 1, -70)

-- Левая панель (игроки)
local PlayersPanel = Instance.new("Frame")
PlayersPanel.Name = "PlayersPanel"
PlayersPanel.Parent = Content
PlayersPanel.BackgroundColor3 = Color3.fromRGB(25, 35, 50)
PlayersPanel.Size = UDim2.new(0.3, 0, 1, 0)
PlayersPanel.Position = UDim2.new(0, 0, 0, 0)

local PlayersCorner = Instance.new("UICorner")
PlayersCorner.CornerRadius = UDim.new(0, 8)
PlayersCorner.Parent = PlayersPanel

local PlayersHeader = Instance.new("TextLabel")
PlayersHeader.Name = "PlayersHeader"
PlayersHeader.Parent = PlayersPanel
PlayersHeader.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
PlayersHeader.Size = UDim2.new(1, 0, 0, 40)
PlayersHeader.Font = Enum.Font.GothamBold
PlayersHeader.Text = "PLAYERS ONLINE"
PlayersHeader.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayersHeader.TextSize = 14

local PlayersList = Instance.new("ScrollingFrame")
PlayersList.Name = "PlayersList"
PlayersList.Parent = PlayersPanel
PlayersList.BackgroundTransparency = 1
PlayersList.Size = UDim2.new(1, -5, 1, -45)
PlayersList.Position = UDim2.new(0, 5, 0, 45)
PlayersList.ScrollBarThickness = 5
PlayersList.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayersList.AutomaticCanvasSize = Enum.AutomaticSize.Y

local PlayerTemplate = Instance.new("TextLabel")
PlayerTemplate.Name = "PlayerTemplate"
PlayerTemplate.Parent = PlayersList
PlayerTemplate.BackgroundTransparency = 1
PlayerTemplate.Size = UDim2.new(1, 0, 0, 30)
PlayerTemplate.Font = Enum.Font.Gotham
PlayerTemplate.Text = ""
PlayerTemplate.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayerTemplate.TextSize = 13
PlayerTemplate.TextXAlignment = Enum.TextXAlignment.Left
PlayerTemplate.Visible = false

-- Правая панель (чат)
local ChatPanel = Instance.new("Frame")
ChatPanel.Name = "ChatPanel"
ChatPanel.Parent = Content
ChatPanel.BackgroundColor3 = Color3.fromRGB(25, 35, 50)
ChatPanel.Size = UDim2.new(0.68, 0, 1, 0)
ChatPanel.Position = UDim2.new(0.32, 0, 0, 0)

local ChatCorner = Instance.new("UICorner")
ChatCorner.CornerRadius = UDim.new(0, 8)
ChatCorner.Parent = ChatPanel

local ChatHeader = Instance.new("TextLabel")
ChatHeader.Name = "ChatHeader"
ChatHeader.Parent = ChatPanel
ChatHeader.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
ChatHeader.Size = UDim2.new(1, 0, 0, 40)
ChatHeader.Font = Enum.Font.GothamBold
ChatHeader.Text = "GGH CHAT"
ChatHeader.TextColor3 = Color3.fromRGB(255, 255, 255)
ChatHeader.TextSize = 16

local MessagesScroll = Instance.new("ScrollingFrame")
MessagesScroll.Name = "MessagesScroll"
MessagesScroll.Parent = ChatPanel
MessagesScroll.BackgroundTransparency = 1
MessagesScroll.Size = UDim2.new(1, -10, 1, -100)
MessagesScroll.Position = UDim2.new(0, 5, 0, 45)
MessagesScroll.ScrollBarThickness = 8
MessagesScroll.ScrollBarImageColor3 = Color3.fromRGB(0, 150, 255)
MessagesScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
MessagesScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y

local MessageTemplate = Instance.new("TextLabel")
MessageTemplate.Name = "MessageTemplate"
MessageTemplate.Parent = MessagesScroll
MessageTemplate.BackgroundTransparency = 1
MessageTemplate.Size = UDim2.new(1, -10, 0, 0)
MessageTemplate.Font = Enum.Font.Gotham
MessageTemplate.Text = ""
MessageTemplate.TextColor3 = Color3.fromRGB(255, 255, 255)
MessageTemplate.TextSize = 13
MessageTemplate.TextWrapped = true
MessageTemplate.TextXAlignment = Enum.TextXAlignment.Left
MessageTemplate.Visible = false

-- Панель ввода
local InputPanel = Instance.new("Frame")
InputPanel.Name = "InputPanel"
InputPanel.Parent = ChatPanel
InputPanel.BackgroundColor3 = Color3.fromRGB(35, 45, 65)
InputPanel.Size = UDim2.new(1, -10, 0, 50)
InputPanel.Position = UDim2.new(0, 5, 1, -55)

local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 6)
InputCorner.Parent = InputPanel

local ChatInput = Instance.new("TextBox")
ChatInput.Name = "ChatInput"
ChatInput.Parent = InputPanel
ChatInput.BackgroundColor3 = Color3.fromRGB(20, 30, 45)
ChatInput.Size = UDim2.new(0.75, 0, 0.8, 0)
ChatInput.Position = UDim2.new(0.02, 0, 0.1, 0)
ChatInput.Font = Enum.Font.Gotham
ChatInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 180)
ChatInput.PlaceholderText = "Type message..."
ChatInput.Text = ""
ChatInput.TextColor3 = Color3.fromRGB(255, 255, 255)
ChatInput.TextSize = 14
ChatInput.TextXAlignment = Enum.TextXAlignment.Left

local SendButton = Instance.new("TextButton")
SendButton.Name = "SendButton"
SendButton.Parent = InputPanel
SendButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
SendButton.Size = UDim2.new(0.2, 0, 0.8, 0)
SendButton.Position = UDim2.new(0.78, 0, 0.1, 0)
SendButton.Font = Enum.Font.GothamBold
SendButton.Text = "SEND"
SendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SendButton.TextSize = 14
SendButton.AutoButtonColor = false

-- Минимизированный вид
local MinimizedFrame = Instance.new("Frame")
MinimizedFrame.Name = "MinimizedFrame"
MinimizedFrame.Parent = ScreenGui
MinimizedFrame.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
MinimizedFrame.BorderSizePixel = 0
MinimizedFrame.Position = MainFrame.Position
MinimizedFrame.Size = UDim2.new(0, 160, 0, 40)
MinimizedFrame.Active = true
MinimizedFrame.Draggable = true
MinimizedFrame.Visible = false

local OpenButton = Instance.new("TextButton")
OpenButton.Name = "OpenButton"
OpenButton.Parent = MinimizedFrame
OpenButton.BackgroundTransparency = 1
OpenButton.Size = UDim2.new(1, 0, 1, 0)
OpenButton.Font = Enum.Font.GothamBold
OpenButton.Text = "GGH CHAT"
OpenButton.TextColor3 = Color3.fromRGB(255, 255, 255)
OpenButton.TextSize = 14

-- Функции
local function calculateTextHeight(text, width)
    local TextService = game:GetService("TextService")
    local textSize = TextService:GetTextSize(
        text,
        13,
        Enum.Font.Gotham,
        Vector2.new(width - 20, math.huge)
    )
    return math.max(25, textSize.Y + 10)
end

local function addMessageToChat(sender, message, isSystem, color, messageId)
    -- Проверяем, не получали ли мы уже это сообщение
    if messageId and ReceivedMessageIds[messageId] then
        return -- Пропускаем дубликат
    end
    
    if messageId then
        ReceivedMessageIds[messageId] = true
    end
    
    local timestamp = os.date("%H:%M:%S")
    local displayName = isSystem and "[SYSTEM]" or sender
    local textColor = isSystem and Color3.fromRGB(255, 200, 0) or color or Color3.fromRGB(200, 200, 255)
    
    -- Создаем сообщение
    local newMessage = MessageTemplate:Clone()
    newMessage.Parent = MessagesScroll
    newMessage.Visible = true
    newMessage.TextColor3 = textColor
    
    local messageText
    if isSystem then
        messageText = string.format("[%s] %s: %s", timestamp, displayName, message)
    else
        messageText = string.format("[%s] %s: %s", timestamp, displayName, message)
    end
    
    newMessage.Text = messageText
    
    -- Вычисляем высоту
    local messageWidth = MessagesScroll.AbsoluteSize.X - 20
    local messageHeight = calculateTextHeight(messageText, messageWidth)
    newMessage.Size = UDim2.new(1, -10, 0, messageHeight)
    
    -- Позиционируем
    local totalHeight = 0
    for _, child in pairs(MessagesScroll:GetChildren()) do
        if child:IsA("TextLabel") and child ~= MessageTemplate and child ~= newMessage then
            totalHeight = totalHeight + child.Size.Y.Offset + 5
        end
    end
    
    newMessage.Position = UDim2.new(0, 5, 0, totalHeight)
    
    -- Автопрокрутка
    wait(0.05)
    MessagesScroll.CanvasPosition = Vector2.new(0, MessagesScroll.CanvasSize.Y.Offset)
    
    -- Сохраняем в локальную историю
    table.insert(MyMessages, {
        id = messageId or #MyMessages + 1,
        sender = sender,
        message = message,
        timestamp = timestamp,
        isSystem = isSystem,
        color = textColor
    })
    
    -- Обновляем глобальную таблицу (только свои сообщения)
    if sender == Player.Name then
        _G.GGH_CHAT_GLOBAL.LastMessageId = _G.GGH_CHAT_GLOBAL.LastMessageId + 1
        _G.GGH_CHAT_GLOBAL.Messages[_G.GGH_CHAT_GLOBAL.LastMessageId] = {
            Sender = Player.Name,
            Message = message,
            Color = color,
            Timestamp = timestamp,
            SessionId = MY_ID,
            MessageId = _G.GGH_CHAT_GLOBAL.LastMessageId
        }
    end
end

local function updatePlayersList()
    -- Очищаем список
    for _, child in pairs(PlayersList:GetChildren()) do
        if child:IsA("TextLabel") and child ~= PlayerTemplate then
            child:Destroy()
        end
    end
    
    local yOffset = 0
    
    -- Добавляем себя
    local myEntry = PlayerTemplate:Clone()
    myEntry.Parent = PlayersList
    myEntry.Visible = true
    myEntry.Text = Player.Name .. " (YOU)"
    myEntry.TextColor3 = MyColor
    myEntry.Position = UDim2.new(0, 5, 0, yOffset)
    yOffset = yOffset + 30
    
    -- Добавляем других игроков из глобальной таблицы
    local onlineCount = 1
    for sessionId, sessionData in pairs(_G.GGH_CHAT_GLOBAL.Sessions) do
        if sessionId ~= MY_ID and sessionData.Active and (tick() - sessionData.LastPing) < 10 then
            onlineCount = onlineCount + 1
            
            local playerEntry = PlayerTemplate:Clone()
            playerEntry.Parent = PlayersList
            playerEntry.Visible = true
            playerEntry.Text = sessionData.PlayerName
            playerEntry.TextColor3 = sessionData.Color
            playerEntry.Position = UDim2.new(0, 5, 0, yOffset)
            yOffset = yOffset + 30
        end
    end
    
    -- Обновляем заголовок
    PlayersHeader.Text = string.format("PLAYERS ONLINE (%d)", onlineCount - 1)
    Status.Text = string.format("Connected • Players: %d", onlineCount)
end

local function sendChatMessage(message)
    if not message or #message == 0 or #message > 250 then return end
    
    -- Генерируем уникальный ID для сообщения
    local messageId = MY_ID .. "_" .. tick()
    
    -- Добавляем локально
    addMessageToChat(Player.Name, message, false, MyColor, messageId)
    
    -- Добавляем в глобальную таблицу
    _G.GGH_CHAT_GLOBAL.LastMessageId = _G.GGH_CHAT_GLOBAL.LastMessageId + 1
    _G.GGH_CHAT_GLOBAL.Messages[_G.GGH_CHAT_GLOBAL.LastMessageId] = {
        Sender = Player.Name,
        Message = message,
        Color = MyColor,
        Timestamp = os.date("%H:%M:%S"),
        SessionId = MY_ID,
        MessageId = _G.GGH_CHAT_GLOBAL.LastMessageId
    }
    
    ChatInput.Text = ""
    ChatInput:CaptureFocus()
end

local function checkNewMessages()
    -- Проверяем новые сообщения в глобальной таблице
    for messageId, messageData in pairs(_G.GGH_CHAT_GLOBAL.Messages) do
        if not ReceivedMessageIds[messageId] and messageData.Sender ~= Player.Name then
            -- Проверяем активен ли отправитель
            local senderSession = _G.GGH_CHAT_GLOBAL.Sessions[messageData.SessionId]
            if senderSession and senderSession.Active then
                addMessageToChat(
                    messageData.Sender,
                    messageData.Message,
                    false,
                    messageData.Color,
                    messageId
                )
            end
        end
    end
end

local function updateActivePlayers()
    -- Обновляем свой статус
    _G.GGH_CHAT_GLOBAL.Sessions[MY_ID].LastPing = tick()
    _G.GGH_CHAT_GLOBAL.Sessions[MY_ID].Active = true
    
    -- Проверяем других игроков
    for sessionId, sessionData in pairs(_G.GGH_CHAT_GLOBAL.Sessions) do
        if sessionId ~= MY_ID then
            if tick() - sessionData.LastPing > 30 then
                sessionData.Active = false
            end
        end
    end
    
    updatePlayersList()
end

local function clearChat()
    for _, child in pairs(MessagesScroll:GetChildren()) do
        if child:IsA("TextLabel") and child ~= MessageTemplate then
            child:Destroy()
        end
    end
    MyMessages = {}
    ReceivedMessageIds = {}
    addMessageToChat("SYSTEM", "Chat cleared", true)
end

local function toggleMinimize()
    if MainFrame.Visible then
        MainFrame.Visible = false
        MinimizedFrame.Visible = true
        MinimizedFrame.Position = MainFrame.Position
        MinimizedFrame.Size = UDim2.new(0, 160, 0, 40)
    else
        MainFrame.Visible = true
        MinimizedFrame.Visible = false
    end
end

-- Привязка событий
SendButton.MouseButton1Click:Connect(function()
    sendChatMessage(ChatInput.Text)
end)

ChatInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        sendChatMessage(ChatInput.Text)
    end
end)

CloseBtn.MouseButton1Click:Connect(function()
    _G.GGH_CHAT_GLOBAL.Sessions[MY_ID].Active = false
    ScreenGui:Destroy()
end)

MinimizeBtn.MouseButton1Click:Connect(toggleMinimize)
OpenButton.MouseButton1Click:Connect(toggleMinimize)

-- Горячие клавиши
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Slash then
        ChatInput:CaptureFocus()
    elseif input.KeyCode == Enum.KeyCode.Return and ChatInput:IsFocused() then
        sendChatMessage(ChatInput.Text)
    elseif input.KeyCode == Enum.KeyCode.Escape then
        ChatInput:ReleaseFocus()
    elseif input.KeyCode == Enum.KeyCode.L and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
        clearChat()
    elseif input.KeyCode == Enum.KeyCode.M and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
        toggleMinimize()
    end
end)

-- Анимации кнопок
CloseBtn.MouseEnter:Connect(function()
    CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
end)

CloseBtn.MouseLeave:Connect(function()
    CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
end)

SendButton.MouseEnter:Connect(function()
    SendButton.BackgroundColor3 = Color3.fromRGB(0, 180, 255)
end)

SendButton.MouseLeave:Connect(function()
    SendButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
end)

-- Инициализация
addMessageToChat("SYSTEM", "GGH Chat v4.0 initialized", true)
addMessageToChat("SYSTEM", "Scanning for other players...", true)
addMessageToChat("SYSTEM", "Use / to focus chat, Ctrl+L to clear, Ctrl+M to minimize", true)

-- Обновляем список игроков
updatePlayersList()

-- Главный цикл обновления
spawn(function()
    while wait(1) and ScreenGui.Parent do
        updateActivePlayers()
        checkNewMessages()
    end
end)

-- Периодический ping
spawn(function()
    while wait(5) and ScreenGui.Parent do
        _G.GGH_CHAT_GLOBAL.Sessions[MY_ID].LastPing = tick()
        _G.GGH_CHAT_GLOBAL.Sessions[MY_ID].Active = true
    end
end)

-- Тестовое сообщение через 3 секунды
spawn(function()
    wait(3)
    addMessageToChat("SYSTEM", "Ready! Other players will appear here automatically", true)
end)

print("========================================")
print("GGH CHAT v4.0 - ACTIVE")
print("Session ID: " .. MY_ID)
print("Your color: " .. tostring(MyColor))
print("Messages will not duplicate")
print("========================================")

-- Экспортируем API
return {
    SendMessage = sendChatMessage,
    ClearChat = clearChat,
    GetPlayers = function()
        local players = {}
        for _, session in pairs(_G.GGH_CHAT_GLOBAL.Sessions) do
            if session.Active then
                table.insert(players, session.PlayerName)
            end
        end
        return players
    end
}
