-- GGH Chat v5.0 - Простой РАБОЧИЙ чат через SharedTable

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local Player = Players.LocalPlayer

-- СОЗДАЕМ ГЛОБАЛЬНУЮ ТАБЛИЦУ для всех игроков
if not _G.GGH_SHARED_CHAT then
    _G.GGH_SHARED_CHAT = {
        Messages = {},
        Players = {},
        LastUpdate = tick()
    }
end

-- Мой уникальный ID
local MY_PLAYER_ID = "P_" .. Player.UserId .. "_" .. HttpService:GenerateGUID(false):sub(1, 4)
local MY_COLOR = Color3.fromHSV(math.random(), 0.8, 0.9)

-- Регистрируем себя
_G.GGH_SHARED_CHAT.Players[MY_PLAYER_ID] = {
    Name = Player.Name,
    Color = MY_COLOR,
    LastActive = tick(),
    Active = true
}

-- Создаем GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GGH_Chat_V5"
ScreenGui.Parent = game:GetService("CoreGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Главное окно
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 25, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.7, 0, 0.3, 0)
MainFrame.Size = UDim2.new(0, 450, 0, 500)
MainFrame.Active = true
MainFrame.Draggable = true

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Заголовок
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Parent = MainFrame
TitleBar.BackgroundColor3 = Color3.fromRGB(30, 40, 55)
TitleBar.Size = UDim2.new(1, 0, 0, 40)

local TitleText = Instance.new("TextLabel")
TitleText.Name = "TitleText"
TitleText.Parent = TitleBar
TitleText.BackgroundTransparency = 1
TitleText.Size = UDim2.new(0.7, 0, 1, 0)
TitleText.Position = UDim2.new(0.05, 0, 0, 0)
TitleText.Font = Enum.Font.GothamBold
TitleText.Text = "GGH CHAT v5.0"
TitleText.TextColor3 = Color3.fromRGB(0, 180, 255)
TitleText.TextSize = 18
TitleText.TextXAlignment = Enum.TextXAlignment.Left

local PlayerCount = Instance.new("TextLabel")
PlayerCount.Name = "PlayerCount"
PlayerCount.Parent = TitleBar
PlayerCount.BackgroundTransparency = 1
PlayerCount.Size = UDim2.new(0.2, 0, 1, 0)
PlayerCount.Position = UDim2.new(0.75, 0, 0, 0)
PlayerCount.Font = Enum.Font.Gotham
PlayerCount.Text = "Players: 1"
PlayerCount.TextColor3 = Color3.fromRGB(150, 200, 255)
PlayerCount.TextSize = 14

local CloseBtn = Instance.new("TextButton")
CloseBtn.Name = "CloseBtn"
CloseBtn.Parent = TitleBar
CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(0.95, -35, 0.5, -15)
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.TextSize = 16
CloseBtn.AutoButtonColor = false

-- Область сообщений
local ChatFrame = Instance.new("ScrollingFrame")
ChatFrame.Name = "ChatFrame"
ChatFrame.Parent = MainFrame
ChatFrame.BackgroundColor3 = Color3.fromRGB(15, 20, 28)
ChatFrame.BorderSizePixel = 0
ChatFrame.Position = UDim2.new(0.02, 0, 0.1, 0)
ChatFrame.Size = UDim2.new(0.96, 0, 0.75, 0)
ChatFrame.ScrollBarThickness = 8
ChatFrame.ScrollBarImageColor3 = Color3.fromRGB(0, 150, 255)
ChatFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ChatFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y

-- Шаблон сообщения
local MessageTemplate = Instance.new("TextLabel")
MessageTemplate.Name = "MessageTemplate"
MessageTemplate.Parent = ChatFrame
MessageTemplate.BackgroundTransparency = 1
MessageTemplate.Size = UDim2.new(0.98, 0, 0, 0)
MessageTemplate.Font = Enum.Font.Gotham
MessageTemplate.Text = ""
MessageTemplate.TextColor3 = Color3.fromRGB(255, 255, 255)
MessageTemplate.TextSize = 13
MessageTemplate.TextWrapped = true
MessageTemplate.TextXAlignment = Enum.TextXAlignment.Left
MessageTemplate.Visible = false

-- Панель ввода
local InputFrame = Instance.new("Frame")
InputFrame.Name = "InputFrame"
InputFrame.Parent = MainFrame
InputFrame.BackgroundColor3 = Color3.fromRGB(30, 40, 55)
InputFrame.Position = UDim2.new(0.02, 0, 0.86, 0)
InputFrame.Size = UDim2.new(0.96, 0, 0.12, 0)

local ChatInput = Instance.new("TextBox")
ChatInput.Name = "ChatInput"
ChatInput.Parent = InputFrame
ChatInput.BackgroundColor3 = Color3.fromRGB(40, 50, 70)
ChatInput.Size = UDim2.new(0.7, 0, 0.7, 0)
ChatInput.Position = UDim2.new(0.02, 0, 0.15, 0)
ChatInput.Font = Enum.Font.Gotham
ChatInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 180)
ChatInput.PlaceholderText = "Type message here..."
ChatInput.Text = ""
ChatInput.TextColor3 = Color3.fromRGB(255, 255, 255)
ChatInput.TextSize = 14
ChatInput.TextXAlignment = Enum.TextXAlignment.Left

local SendButton = Instance.new("TextButton")
SendButton.Name = "SendButton"
SendButton.Parent = InputFrame
SendButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
SendButton.Size = UDim2.new(0.25, 0, 0.7, 0)
SendButton.Position = UDim2.new(0.73, 0, 0.15, 0)
SendButton.Font = Enum.Font.GothamBold
SendButton.Text = "SEND"
SendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SendButton.TextSize = 14
SendButton.AutoButtonColor = false

-- Закругления
local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 6)
InputCorner.Parent = ChatInput

local SendCorner = Instance.new("UICorner")
SendCorner.CornerRadius = UDim.new(0, 6)
SendCorner.Parent = SendButton

-- Функции чата
local lastMessageId = 0
local displayedMessages = {}

local function addMessage(sender, message, color, isSystem, messageId)
    -- Проверяем, не отображали ли уже это сообщение
    if displayedMessages[messageId] then
        return
    end
    
    displayedMessages[messageId] = true
    
    local timestamp = os.date("%H:%M:%S")
    local displayName = isSystem and "[SYSTEM]" or sender
    local messageColor = isSystem and Color3.fromRGB(255, 200, 0) or color
    
    -- Создаем новый элемент сообщения
    local newMessage = MessageTemplate:Clone()
    newMessage.Parent = ChatFrame
    newMessage.Visible = true
    newMessage.TextColor3 = messageColor
    
    local messageText = string.format("[%s] %s: %s", timestamp, displayName, message)
    newMessage.Text = messageText
    
    -- Вычисляем высоту текста
    local TextService = game:GetService("TextService")
    local textSize = TextService:GetTextSize(
        messageText,
        13,
        Enum.Font.Gotham,
        Vector2.new(ChatFrame.AbsoluteSize.X - 30, math.huge)
    )
    
    local messageHeight = math.max(25, textSize.Y + 10)
    newMessage.Size = UDim2.new(0.98, 0, 0, messageHeight)
    
    -- Позиционируем
    local totalHeight = 0
    for _, child in pairs(ChatFrame:GetChildren()) do
        if child:IsA("TextLabel") and child ~= MessageTemplate and child ~= newMessage then
            totalHeight = totalHeight + child.Size.Y.Offset + 5
        end
    end
    
    newMessage.Position = UDim2.new(0.01, 0, 0, totalHeight)
    
    -- Автопрокрутка
    wait(0.05)
    ChatFrame.CanvasPosition = Vector2.new(0, ChatFrame.CanvasSize.Y.Offset)
end

local function sendMessage(text)
    if not text or #text == 0 or #text > 200 then
        return
    end
    
    -- Генерируем уникальный ID для сообщения
    local messageId = MY_PLAYER_ID .. "_" .. tick()
    
    -- Добавляем в общую таблицу
    _G.GGH_SHARED_CHAT.Messages[messageId] = {
        Sender = Player.Name,
        Message = text,
        Color = MY_COLOR,
        Timestamp = os.time(),
        IsSystem = false,
        MessageId = messageId,
        PlayerId = MY_PLAYER_ID
    }
    
    _G.GGH_SHARED_CHAT.LastUpdate = tick()
    
    -- Отображаем локально
    addMessage(Player.Name, text, MY_COLOR, false, messageId)
    
    ChatInput.Text = ""
    ChatInput:CaptureFocus()
end

local function updatePlayerList()
    -- Подсчитываем активных игроков
    local activeCount = 0
    local currentTime = tick()
    
    for playerId, playerData in pairs(_G.GGH_SHARED_CHAT.Players) do
        if currentTime - playerData.LastActive < 10 then
            activeCount = activeCount + 1
        end
    end
    
    PlayerCount.Text = "Players: " .. activeCount
    
    -- Обновляем свой статус активности
    _G.GGH_SHARED_CHAT.Players[MY_PLAYER_ID].LastActive = currentTime
    _G.GGH_SHARED_CHAT.Players[MY_PLAYER_ID].Active = true
end

local function checkNewMessages()
    local currentTime = tick()
    
    -- Проверяем новые сообщения в общей таблице
    for messageId, messageData in pairs(_G.GGH_SHARED_CHAT.Messages) do
        -- Проверяем, не старое ли сообщение (больше 1 минуты)
        if currentTime - messageData.Timestamp < 60 then
            -- Проверяем, не наше ли это сообщение
            if messageData.PlayerId ~= MY_PLAYER_ID then
                -- Проверяем, не отображали ли уже
                if not displayedMessages[messageId] then
                    -- Проверяем, активен ли отправитель
                    local senderData = _G.GGH_SHARED_CHAT.Players[messageData.PlayerId]
                    if senderData and (currentTime - senderData.LastActive < 10) then
                        addMessage(
                            messageData.Sender,
                            messageData.Message,
                            messageData.Color,
                            false,
                            messageId
                        )
                    end
                end
            end
        end
    end
end

local function cleanupOldData()
    local currentTime = tick()
    local removedCount = 0
    
    -- Удаляем старые сообщения (старше 5 минут)
    for messageId, messageData in pairs(_G.GGH_SHARED_CHAT.Messages) do
        if currentTime - messageData.Timestamp > 300 then
            _G.GGH_SHARED_CHAT.Messages[messageId] = nil
            removedCount = removedCount + 1
        end
    end
    
    -- Удаляем неактивных игроков (неактивны больше 30 секунд)
    for playerId, playerData in pairs(_G.GGH_SHARED_CHAT.Players) do
        if currentTime - playerData.LastActive > 30 then
            _G.GGH_SHARED_CHAT.Players[playerId] = nil
        end
    end
    
    if removedCount > 0 then
        _G.GGH_SHARED_CHAT.LastUpdate = currentTime
    end
end

local function initChat()
    -- Добавляем приветственные сообщения
    addMessage("SYSTEM", "GGH Chat v5.0 activated!", Color3.fromRGB(255, 200, 0), true, "sys_init")
    addMessage("SYSTEM", "Connected to shared chat network", Color3.fromRGB(255, 200, 0), true, "sys_conn")
    addMessage("SYSTEM", "Other players will appear automatically", Color3.fromRGB(255, 200, 0), true, "sys_players")
end

-- Обработчики событий
SendButton.MouseButton1Click:Connect(function()
    sendMessage(ChatInput.Text)
end)

ChatInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        sendMessage(ChatInput.Text)
    end
end)

CloseBtn.MouseButton1Click:Connect(function()
    _G.GGH_SHARED_CHAT.Players[MY_PLAYER_ID].Active = false
    ScreenGui:Destroy()
end)

-- Горячие клавиши
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Slash then
        ChatInput:CaptureFocus()
    elseif input.KeyCode == Enum.KeyCode.Return and ChatInput:IsFocused() then
        sendMessage(ChatInput.Text)
    elseif input.KeyCode == Enum.KeyCode.Escape then
        ChatInput:ReleaseFocus()
    end
end)

-- Анимации кнопок
CloseBtn.MouseEnter:Connect(function()
    TweenService:Create(CloseBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 100, 100)}):Play()
end)

CloseBtn.MouseLeave:Connect(function()
    TweenService:Create(CloseBtn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(255, 60, 60)}):Play()
end)

SendButton.MouseEnter:Connect(function()
    TweenService:Create(SendButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(0, 180, 255)}):Play()
end)

SendButton.MouseLeave:Connect(function()
    TweenService:Create(SendButton, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(0, 150, 255)}):Play()
end)

-- Инициализация
initChat()

-- Главный цикл обновления
spawn(function()
    while wait(0.5) do
        if not ScreenGui.Parent then break end
        
        updatePlayerList()
        checkNewMessages()
        
        -- Периодическая очистка старых данных
        if tick() % 30 < 0.5 then
            cleanupOldData()
        end
    end
end)

-- Уведомление о входе
spawn(function()
    wait(2)
    local joinId = "join_" .. MY_PLAYER_ID
    _G.GGH_SHARED_CHAT.Messages[joinId] = {
        Sender = "SYSTEM",
        Message = Player.Name .. " joined the chat",
        Color = Color3.fromRGB(0, 255, 150),
        Timestamp = os.time(),
        IsSystem = true,
        MessageId = joinId,
        PlayerId = MY_PLAYER_ID
    }
    
    addMessage("SYSTEM", Player.Name .. " joined the chat", Color3.fromRGB(0, 255, 150), true, joinId)
end)

print("=================================================================")
print("GGH CHAT v5.0 - ACTIVE AND WORKING")
print("Player ID: " .. MY_PLAYER_ID)
print("Color: " .. tostring(MY_COLOR))
print("=================================================================")
print("Все игроки с этим скриптом видят друг друга через _G.GGH_SHARED_CHAT")
print("Сообщения передаются мгновенно без дублирования")
print("=================================================================")

-- Возвращаем API для внешнего использования
return {
    SendMessage = sendMessage,
    GetActivePlayers = function()
        local players = {}
        local currentTime = tick()
        
        for playerId, playerData in pairs(_G.GGH_SHARED_CHAT.Players) do
            if currentTime - playerData.LastActive < 10 then
                table.insert(players, {
                    Name = playerData.Name,
                    Color = playerData.Color
                })
            end
        end
        
        return players
    end
}
