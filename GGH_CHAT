-- GGH Chat v2.0 - Стильный рабочий чат для Roblox Lua инжекторов

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Player = Players.LocalPlayer
local Mouse = Player:GetMouse()

-- Создаем RemoteEvent для чата
local GGHRemoteEvent
local GGHRemoteFunction

if not ReplicatedStorage:FindFirstChild("GGH_Chat_Remote") then
    GGHRemoteEvent = Instance.new("RemoteEvent")
    GGHRemoteEvent.Name = "GGH_Chat_Remote"
    GGHRemoteEvent.Parent = ReplicatedStorage
else
    GGHRemoteEvent = ReplicatedStorage:FindFirstChild("GGH_Chat_Remote")
end

if not ReplicatedStorage:FindFirstChild("GGH_Chat_Function") then
    GGHRemoteFunction = Instance.new("RemoteFunction")
    GGHRemoteFunction.Name = "GGH_Chat_Function"
    GGHRemoteFunction.Parent = ReplicatedStorage
else
    GGHRemoteFunction = ReplicatedStorage:FindFirstChild("GGH_Chat_Function")
end

-- Данные чата
local GGHPlayers = {}
local isChatVisible = true
local chatMessages = {}
local isMinimized = false
local playersListVisible = true
local chatHistory = {}
local messageCount = 0

-- Цветовая схема
local ColorScheme = {
    Background = Color3.fromRGB(18, 18, 24),
    Secondary = Color3.fromRGB(28, 28, 36),
    Accent = Color3.fromRGB(0, 170, 255),
    AccentDark = Color3.fromRGB(0, 140, 210),
    Text = Color3.fromRGB(240, 240, 245),
    TextSecondary = Color3.fromRGB(170, 170, 180),
    Success = Color3.fromRGB(0, 200, 83),
    Warning = Color3.fromRGB(255, 145, 0),
    Error = Color3.fromRGB(255, 82, 82),
    Online = Color3.fromRGB(76, 175, 80),
    Offline = Color3.fromRGB(158, 158, 158)
}

-- Цвета игроков
local playerColors = {
    Color3.fromRGB(255, 87, 87),   -- Красный
    Color3.fromRGB(87, 255, 87),   -- Зеленый
    Color3.fromRGB(87, 87, 255),   -- Синий
    Color3.fromRGB(255, 255, 87),  -- Желтый
    Color3.fromRGB(255, 87, 255),  -- Розовый
    Color3.fromRGB(87, 255, 255),  -- Голубой
    Color3.fromRGB(255, 170, 87),  -- Оранжевый
    Color3.fromRGB(170, 87, 255),  -- Фиолетовый
    Color3.fromRGB(87, 255, 170),  -- Бирюзовый
    Color3.fromRGB(200, 200, 100)  -- Светло-желтый
}

local myColor = playerColors[math.random(1, #playerColors)]

-- Создание GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GGH_Chat"
ScreenGui.Parent = game:GetService("CoreGui") or Player:WaitForChild("PlayerGui")
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false
ScreenGui.DisplayOrder = 999

-- Основной контейнер
local MainContainer = Instance.new("Frame")
MainContainer.Name = "MainContainer"
MainContainer.Parent = ScreenGui
MainContainer.BackgroundColor3 = ColorScheme.Background
MainContainer.BackgroundTransparency = 0.1
MainContainer.BorderSizePixel = 0
MainContainer.Size = UDim2.new(0, 600, 0, 500)
MainContainer.Position = UDim2.new(0.65, 0, 0.2, 0)
MainContainer.Active = true
MainContainer.Draggable = true

-- Закругление
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainContainer

-- Тень
local UIStroke = Instance.new("UIStroke")
UIStroke.Color = ColorScheme.Accent
UIStroke.Thickness = 1
UIStroke.Parent = MainContainer

-- Верхняя панель
local TopBar = Instance.new("Frame")
TopBar.Name = "TopBar"
TopBar.Parent = MainContainer
TopBar.BackgroundColor3 = ColorScheme.Secondary
TopBar.BorderSizePixel = 0
TopBar.Size = UDim2.new(1, 0, 0, 50)

local UICorner2 = Instance.new("UICorner")
UICorner2.CornerRadius = UDim.new(0, 12)
UICorner2.Parent = TopBar

-- Логотип и название
local LogoContainer = Instance.new("Frame")
LogoContainer.Name = "LogoContainer"
LogoContainer.Parent = TopBar
LogoContainer.BackgroundTransparency = 1
LogoContainer.Size = UDim2.new(0, 200, 1, 0)
LogoContainer.Position = UDim2.new(0, 15, 0, 0)

local LogoText = Instance.new("TextLabel")
LogoText.Name = "LogoText"
LogoText.Parent = LogoContainer
LogoText.BackgroundTransparency = 1
LogoText.Size = UDim2.new(1, 0, 0.6, 0)
LogoText.Position = UDim2.new(0, 0, 0.2, 0)
LogoText.Font = Enum.Font.GothamBold
LogoText.Text = "GGH CHAT"
LogoText.TextColor3 = ColorScheme.Accent
LogoText.TextSize = 20
LogoText.TextXAlignment = Enum.TextXAlignment.Left

local Subtitle = Instance.new("TextLabel")
Subtitle.Name = "Subtitle"
Subtitle.Parent = LogoContainer
Subtitle.BackgroundTransparency = 1
Subtitle.Size = UDim2.new(1, 0, 0.4, 0)
Subtitle.Position = UDim2.new(0, 0, 0.6, 0)
Subtitle.Font = Enum.Font.Gotham
Subtitle.Text = "Roblox Lua Exploiter Chat"
Subtitle.TextColor3 = ColorScheme.TextSecondary
Subtitle.TextSize = 12
Subtitle.TextXAlignment = Enum.TextXAlignment.Left

-- Кнопки управления
local ControlButtons = Instance.new("Frame")
ControlButtons.Name = "ControlButtons"
ControlButtons.Parent = TopBar
ControlButtons.BackgroundTransparency = 1
ControlButtons.Size = UDim2.new(0, 150, 1, 0)
ControlButtons.Position = UDim2.new(1, -165, 0, 0)

-- Функция создания кнопки
local function createControlButton(name, text, position)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Parent = ControlButtons
    button.BackgroundColor3 = ColorScheme.Secondary
    button.Size = UDim2.new(0, 40, 0, 40)
    button.Position = position
    button.Font = Enum.Font.GothamBold
    button.Text = text
    button.TextColor3 = ColorScheme.Text
    button.TextSize = 14
    button.AutoButtonColor = false
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = button
    
    local buttonStroke = Instance.new("UIStroke")
    buttonStroke.Color = ColorScheme.Accent
    buttonStroke.Thickness = 1
    buttonStroke.Parent = button
    
    -- Анимация при наведении
    button.MouseEnter:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = ColorScheme.Accent}):Play()
        TweenService:Create(button, TweenInfo.new(0.2), {TextColor3 = Color3.fromRGB(255, 255, 255)}):Play()
    end)
    
    button.MouseLeave:Connect(function()
        TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = ColorScheme.Secondary}):Play()
        TweenService:Create(button, TweenInfo.new(0.2), {TextColor3 = ColorScheme.Text}):Play()
    end)
    
    return button
end

local MinimizeBtn = createControlButton("MinimizeBtn", "_", UDim2.new(0, 5, 0.5, -20))
local SettingsBtn = createControlButton("SettingsBtn", "⚙", UDim2.new(0, 55, 0.5, -20))
local CloseBtn = createControlButton("CloseBtn", "✕", UDim2.new(0, 105, 0.5, -20))

-- Основное содержимое
local ContentArea = Instance.new("Frame")
ContentArea.Name = "ContentArea"
ContentArea.Parent = MainContainer
ContentArea.BackgroundTransparency = 1
ContentArea.Size = UDim2.new(1, -20, 1, -70)
ContentArea.Position = UDim2.new(0, 10, 0, 60)

-- Панель игроков
local PlayersPanel = Instance.new("Frame")
PlayersPanel.Name = "PlayersPanel"
PlayersPanel.Parent = ContentArea
PlayersPanel.BackgroundColor3 = ColorScheme.Secondary
PlayersPanel.Size = UDim2.new(0.3, 0, 1, 0)
PlayersPanel.Position = UDim2.new(0, 0, 0, 0)

local PanelCorner = Instance.new("UICorner")
PanelCorner.CornerRadius = UDim.new(0, 8)
PanelCorner.Parent = PlayersPanel

local PanelStroke = Instance.new("UIStroke")
PanelStroke.Color = ColorScheme.Accent
PanelStroke.Thickness = 1
PanelStroke.Parent = PlayersPanel

local PlayersHeader = Instance.new("Frame")
PlayersHeader.Name = "PlayersHeader"
PlayersHeader.Parent = PlayersPanel
PlayersHeader.BackgroundColor3 = ColorScheme.Accent
PlayersHeader.Size = UDim2.new(1, 0, 0, 40)
PlayersHeader.Position = UDim2.new(0, 0, 0, 0)

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 8)
HeaderCorner.Parent = PlayersHeader

local PlayersTitle = Instance.new("TextLabel")
PlayersTitle.Name = "PlayersTitle"
PlayersTitle.Parent = PlayersHeader
PlayersTitle.BackgroundTransparency = 1
PlayersTitle.Size = UDim2.new(1, -10, 1, 0)
PlayersTitle.Position = UDim2.new(0, 10, 0, 0)
PlayersTitle.Font = Enum.Font.GothamBold
PlayersTitle.Text = "ИГРОКИ ОНЛАЙН"
PlayersTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayersTitle.TextSize = 14
PlayersTitle.TextXAlignment = Enum.TextXAlignment.Left

local PlayerCount = Instance.new("TextLabel")
PlayerCount.Name = "PlayerCount"
PlayerCount.Parent = PlayersHeader
PlayerCount.BackgroundTransparency = 1
PlayerCount.Size = UDim2.new(0, 40, 1, 0)
PlayerCount.Position = UDim2.new(1, -50, 0, 0)
PlayerCount.Font = Enum.Font.GothamBold
PlayerCount.Text = "0"
PlayerCount.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayerCount.TextSize = 16

local PlayersList = Instance.new("ScrollingFrame")
PlayersList.Name = "PlayersList"
PlayersList.Parent = PlayersPanel
PlayersList.BackgroundTransparency = 1
PlayersList.Size = UDim2.new(1, -10, 1, -50)
PlayersList.Position = UDim2.new(0, 5, 0, 45)
PlayersList.ScrollBarThickness = 6
PlayersList.ScrollBarImageColor3 = ColorScheme.Accent
PlayersList.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayersList.AutomaticCanvasSize = Enum.AutomaticSize.Y

-- Шаблон игрока
local PlayerTemplate = Instance.new("Frame")
PlayerTemplate.Name = "PlayerTemplate"
PlayerTemplate.Parent = PlayersList
PlayerTemplate.BackgroundColor3 = ColorScheme.Background
PlayerTemplate.Size = UDim2.new(1, -5, 0, 45)
PlayerTemplate.Visible = false

local TemplateCorner = Instance.new("UICorner")
TemplateCorner.CornerRadius = UDim.new(0, 6)
TemplateCorner.Parent = PlayerTemplate

local PlayerColor = Instance.new("Frame")
PlayerColor.Name = "PlayerColor"
PlayerColor.Parent = PlayerTemplate
PlayerColor.BackgroundColor3 = ColorScheme.Online
PlayerColor.Size = UDim2.new(0, 8, 0, 8)
PlayerColor.Position = UDim2.new(0, 10, 0.5, -4)

local ColorCorner = Instance.new("UICorner")
ColorCorner.CornerRadius = UDim.new(1, 0)
ColorCorner.Parent = PlayerColor

local PlayerName = Instance.new("TextLabel")
PlayerName.Name = "PlayerName"
PlayerName.Parent = PlayerTemplate
PlayerName.BackgroundTransparency = 1
PlayerName.Size = UDim2.new(1, -40, 1, 0)
PlayerName.Position = UDim2.new(0, 25, 0, 0)
PlayerName.Font = Enum.Font.Gotham
PlayerName.Text = "Игрок"
PlayerName.TextColor3 = ColorScheme.Text
PlayerName.TextSize = 14
PlayerName.TextXAlignment = Enum.TextXAlignment.Left

-- Область чата
local ChatArea = Instance.new("Frame")
ChatArea.Name = "ChatArea"
ChatArea.Parent = ContentArea
ChatArea.BackgroundColor3 = ColorScheme.Secondary
ChatArea.Size = UDim2.new(0.68, 0, 1, 0)
ChatArea.Position = UDim2.new(0.32, 0, 0, 0)

local ChatCorner = Instance.new("UICorner")
ChatCorner.CornerRadius = UDim.new(0, 8)
ChatCorner.Parent = ChatArea

local ChatStroke = Instance.new("UIStroke")
ChatStroke.Color = ColorScheme.Accent
ChatStroke.Thickness = 1
ChatStroke.Parent = ChatArea

-- Заголовок чата
local ChatHeader = Instance.new("Frame")
ChatHeader.Name = "ChatHeader"
ChatHeader.Parent = ChatArea
ChatHeader.BackgroundColor3 = ColorScheme.Accent
ChatHeader.Size = UDim2.new(1, 0, 0, 40)
ChatHeader.Position = UDim2.new(0, 0, 0, 0)

local ChatHeaderCorner = Instance.new("UICorner")
ChatHeaderCorner.CornerRadius = UDim.new(0, 8)
ChatHeaderCorner.Parent = ChatHeader

local ChatTitle = Instance.new("TextLabel")
ChatTitle.Name = "ChatTitle"
ChatTitle.Parent = ChatHeader
ChatTitle.BackgroundTransparency = 1
ChatTitle.Size = UDim2.new(1, -10, 1, 0)
ChatTitle.Position = UDim2.new(0, 10, 0, 0)
ChatTitle.Font = Enum.Font.GothamBold
ChatTitle.Text = "GGH ЧАТ"
ChatTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
ChatTitle.TextSize = 16
ChatTitle.TextXAlignment = Enum.TextXAlignment.Left

-- Область сообщений
local MessagesContainer = Instance.new("ScrollingFrame")
MessagesContainer.Name = "MessagesContainer"
MessagesContainer.Parent = ChatArea
MessagesContainer.BackgroundTransparency = 1
MessagesContainer.Size = UDim2.new(1, -10, 1, -120)
MessagesContainer.Position = UDim2.new(0, 5, 0, 45)
MessagesContainer.ScrollBarThickness = 6
MessagesContainer.ScrollBarImageColor3 = ColorScheme.Accent
MessagesContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
MessagesContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y

-- Шаблон сообщения
local MessageTemplate = Instance.new("Frame")
MessageTemplate.Name = "MessageTemplate"
MessageTemplate.Parent = MessagesContainer
MessageTemplate.BackgroundTransparency = 1
MessageTemplate.Size = UDim2.new(1, -10, 0, 0)
MessageTemplate.Visible = false

local MessageContent = Instance.new("TextLabel")
MessageContent.Name = "MessageContent"
MessageContent.Parent = MessageTemplate
MessageContent.BackgroundTransparency = 1
MessageContent.Size = UDim2.new(1, 0, 0, 0)
MessageContent.Font = Enum.Font.Gotham
MessageContent.Text = ""
MessageContent.TextColor3 = ColorScheme.Text
MessageContent.TextSize = 13
MessageContent.TextXAlignment = Enum.TextXAlignment.Left
MessageContent.TextYAlignment = Enum.TextYAlignment.Top
MessageContent.TextWrapped = true
MessageContent.RichText = true

-- Панель ввода
local InputPanel = Instance.new("Frame")
InputPanel.Name = "InputPanel"
InputPanel.Parent = ChatArea
InputPanel.BackgroundColor3 = ColorScheme.Background
InputPanel.Size = UDim2.new(1, -20, 0, 60)
InputPanel.Position = UDim2.new(0, 10, 1, -70)

local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 8)
InputCorner.Parent = InputPanel

local InputStroke = Instance.new("UIStroke")
InputStroke.Color = ColorScheme.Accent
InputStroke.Thickness = 1
InputStroke.Parent = InputPanel

local ChatInput = Instance.new("TextBox")
ChatInput.Name = "ChatInput"
ChatInput.Parent = InputPanel
ChatInput.BackgroundTransparency = 1
ChatInput.Size = UDim2.new(0.75, 0, 1, 0)
ChatInput.Position = UDim2.new(0, 15, 0, 0)
ChatInput.Font = Enum.Font.Gotham
ChatInput.PlaceholderColor3 = ColorScheme.TextSecondary
ChatInput.PlaceholderText = "Введите сообщение..."
ChatInput.Text = ""
ChatInput.TextColor3 = ColorScheme.Text
ChatInput.TextSize = 14
ChatInput.TextXAlignment = Enum.TextXAlignment.Left
ChatInput.ClearTextOnFocus = false

local SendButton = Instance.new("TextButton")
SendButton.Name = "SendButton"
SendButton.Parent = InputPanel
SendButton.BackgroundColor3 = ColorScheme.Accent
SendButton.Size = UDim2.new(0.2, 0, 0, 40)
SendButton.Position = UDim2.new(0.78, 0, 0.5, -20)
SendButton.Font = Enum.Font.GothamBold
SendButton.Text = "ОТПРАВИТЬ"
SendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SendButton.TextSize = 14
SendButton.AutoButtonColor = false

local SendCorner = Instance.new("UICorner")
SendCorner.CornerRadius = UDim.new(0, 6)
SendCorner.Parent = SendButton

-- Анимация кнопки отправки
SendButton.MouseEnter:Connect(function()
    TweenService:Create(SendButton, TweenInfo.new(0.2), {BackgroundColor3 = ColorScheme.AccentDark}):Play()
end)

SendButton.MouseLeave:Connect(function()
    TweenService:Create(SendButton, TweenInfo.new(0.2), {BackgroundColor3 = ColorScheme.Accent}):Play()
end)

-- Минимизированная версия
local MinimizedContainer = Instance.new("Frame")
MinimizedContainer.Name = "MinimizedContainer"
MinimizedContainer.Parent = ScreenGui
MinimizedContainer.BackgroundColor3 = ColorScheme.Accent
MinimizedContainer.Size = UDim2.new(0, 180, 0, 50)
MinimizedContainer.Position = MainContainer.Position
MinimizedContainer.Active = true
MinimizedContainer.Draggable = true
MinimizedContainer.Visible = false

local MinimizedCorner = Instance.new("UICorner")
MinimizedCorner.CornerRadius = UDim.new(0, 8)
MinimizedCorner.Parent = MinimizedContainer

local MinimizedStroke = Instance.new("UIStroke")
MinimizedStroke.Color = ColorScheme.AccentDark
MinimizedStroke.Thickness = 2
MinimizedStroke.Parent = MinimizedContainer

local MinimizedButton = Instance.new("TextButton")
MinimizedButton.Name = "MinimizedButton"
MinimizedButton.Parent = MinimizedContainer
MinimizedButton.BackgroundTransparency = 1
MinimizedButton.Size = UDim2.new(1, 0, 1, 0)
MinimizedButton.Font = Enum.Font.GothamBold
MinimizedButton.Text = "GGH CHAT ▶"
MinimizedButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizedButton.TextSize = 16

-- Функции
local function calculateTextHeight(text, fontSize, frameWidth)
    local TextService = game:GetService("TextService")
    local textSize = TextService:GetTextSize(
        text,
        fontSize,
        Enum.Font.Gotham,
        Vector2.new(frameWidth - 20, math.huge)
    )
    return textSize.Y + 10
end

local function addMessageToChat(sender, message, isSystem, color)
    messageCount = messageCount + 1
    
    local newMessage = MessageTemplate:Clone()
    newMessage.Parent = MessagesContainer
    newMessage.Visible = true
    newMessage.Name = "Message_" .. messageCount
    
    local timestamp = os.date("%H:%M:%S")
    local messageContent = MessageContent:Clone()
    messageContent.Parent = newMessage
    messageContent.Size = UDim2.new(1, 0, 0, 0)
    
    local displayName = isSystem and "[SYSTEM]" or sender
    local textColor = isSystem and ColorScheme.Warning or (color or ColorScheme.Text)
    
    local formattedMessage
    if isSystem then
        formattedMessage = string.format(
            '<font color="rgb(%d,%d,%d)">[%s] %s: </font>%s',
            math.floor(ColorScheme.Warning.R * 255),
            math.floor(ColorScheme.Warning.G * 255),
            math.floor(ColorScheme.Warning.B * 255),
            timestamp,
            displayName,
            message
        )
    else
        formattedMessage = string.format(
            '[%s] <font color="rgb(%d,%d,%d)">%s</font>: %s',
            timestamp,
            math.floor(color.R * 255),
            math.floor(color.G * 255),
            math.floor(color.B * 255),
            displayName,
            message
        )
    end
    
    messageContent.Text = formattedMessage
    
    local messageHeight = calculateTextHeight(
        string.format("[%s] %s: %s", timestamp, displayName, message),
        13,
        MessagesContainer.AbsoluteSize.X - 30
    )
    
    messageContent.Size = UDim2.new(1, 0, 0, messageHeight)
    newMessage.Size = UDim2.new(1, 0, 0, messageHeight)
    
    table.insert(chatMessages, {
        id = messageCount,
        sender = sender,
        message = message,
        timestamp = timestamp,
        isSystem = isSystem,
        color = color,
        uiElement = newMessage
    })
    
    wait(0.1)
    MessagesContainer.CanvasPosition = Vector2.new(0, MessagesContainer.CanvasSize.Y.Offset)
end

local function sendChatMessage(message)
    if message and #message > 0 and #message <= 250 then
        local success, err = pcall(function()
            GGHRemoteEvent:FireServer("GGH_Message", {
                Sender = Player.Name,
                Message = message,
                Color = myColor,
                Timestamp = os.date("%H:%M:%S"),
                UserId = Player.UserId
            })
        end)
        
        if success then
            addMessageToChat(Player.Name, message, false, myColor)
            ChatInput.Text = ""
            ChatInput:CaptureFocus()
        else
            addMessageToChat("SYSTEM", "Ошибка отправки: " .. tostring(err), true)
        end
    elseif #message > 250 then
        addMessageToChat("SYSTEM", "Сообщение слишком длинное (макс. 250 символов)", true)
    end
end

local function updatePlayersList()
    for _, child in ipairs(PlayersList:GetChildren()) do
        if child:IsA("Frame") and child ~= PlayerTemplate then
            child:Destroy()
        end
    end
    
    local yPosition = 0
    
    -- Добавляем себя
    local myEntry = PlayerTemplate:Clone()
    myEntry.Parent = PlayersList
    myEntry.Visible = true
    myEntry.Name = "Player_" .. Player.Name
    myEntry.Position = UDim2.new(0, 0, 0, yPosition)
    
    local myColorIndicator = myEntry:FindFirstChild("PlayerColor")
    local myNameLabel = myEntry:FindFirstChild("PlayerName")
    
    if myColorIndicator then
        myColorIndicator.BackgroundColor3 = myColor
    end
    
    if myNameLabel then
        myNameLabel.Text = Player.Name .. " (Вы)"
        myNameLabel.TextColor3 = myColor
    end
    
    yPosition = yPosition + 50
    
    -- Добавляем других игроков
    local otherPlayers = 0
    for playerName, color in pairs(GGHPlayers) do
        if playerName ~= Player.Name then
            otherPlayers = otherPlayers + 1
            
            local playerEntry = PlayerTemplate:Clone()
            playerEntry.Parent = PlayersList
            playerEntry.Visible = true
            playerEntry.Name = "Player_" .. playerName
            playerEntry.Position = UDim2.new(0, 0, 0, yPosition)
            
            local colorIndicator = playerEntry:FindFirstChild("PlayerColor")
            local nameLabel = playerEntry:FindFirstChild("PlayerName")
            
            if colorIndicator then
                colorIndicator.BackgroundColor3 = color
            end
            
            if nameLabel then
                nameLabel.Text = playerName
                nameLabel.TextColor3 = color
            end
            
            yPosition = yPosition + 50
        end
    end
    
    PlayerCount.Text = tostring(otherPlayers)
    
    -- Обновляем заголовок
    PlayersTitle.Text = "ИГРОКИ ОНЛАЙН"
    if otherPlayers > 0 then
        PlayersTitle.Text = PlayersTitle.Text .. " (" .. otherPlayers .. ")"
    end
end

local function registerPlayer(playerName, color)
    if not GGHPlayers[playerName] and playerName ~= Player.Name then
        local assignedColor = color or playerColors[(#GGHPlayers % #playerColors) + 1]
        GGHPlayers[playerName] = assignedColor
        
        local joinMessage = string.format("%s присоединился к GGH Chat", playerName)
        addMessageToChat("SYSTEM", joinMessage, true)
        
        updatePlayersList()
        
        -- Отправляем информацию о себе
        pcall(function()
            GGHRemoteEvent:FireServer("GGH_Register", {
                Sender = Player.Name,
                Color = myColor,
                UserId = Player.UserId
            })
        end)
    end
end

local function removePlayer(playerName)
    if GGHPlayers[playerName] then
        GGHPlayers[playerName] = nil
        
        local leaveMessage = string.format("%s покинул GGH Chat", playerName)
        addMessageToChat("SYSTEM", leaveMessage, true)
        
        updatePlayersList()
    end
end

local function toggleMinimize()
    isMinimized = not isMinimized
    
    if isMinimized then
        TweenService:Create(MainContainer, TweenInfo.new(0.3), {Size = UDim2.new(0, 0, 0, 0)}):Play()
        wait(0.3)
        MainContainer.Visible = false
        MinimizedContainer.Visible = true
        MinimizedContainer.Position = MainContainer.Position
        MinimizedButton.Text = "GGH CHAT (" .. PlayerCount.Text .. ")"
    else
        MainContainer.Visible = true
        MinimizedContainer.Visible = false
        MainContainer.Position = MinimizedContainer.Position
        TweenService:Create(MainContainer, TweenInfo.new(0.3), {Size = UDim2.new(0, 600, 0, 500)}):Play()
    end
end

local function clearChat()
    for _, msg in ipairs(chatMessages) do
        if msg.uiElement and msg.uiElement.Parent then
            msg.uiElement:Destroy()
        end
    end
    chatMessages = {}
    addMessageToChat("SYSTEM", "Чат был очищен", true)
end

local function togglePlayersPanel()
    playersListVisible = not playersListVisible
    
    if playersListVisible then
        PlayersPanel.Visible = true
        ChatArea.Size = UDim2.new(0.68, 0, 1, 0)
        ChatArea.Position = UDim2.new(0.32, 0, 0, 0)
    else
        PlayersPanel.Visible = false
        ChatArea.Size = UDim2.new(0.98, 0, 1, 0)
        ChatArea.Position = UDim2.new(0.01, 0, 0, 0)
    end
end

-- Обработчики событий
GGHRemoteEvent.OnClientEvent:Connect(function(action, data)
    if action == "GGH_Message" then
        if data.Sender and data.Message and data.Color then
            if not GGHPlayers[data.Sender] then
                registerPlayer(data.Sender, data.Color)
            end
            addMessageToChat(data.Sender, data.Message, false, data.Color)
        end
    elseif action == "GGH_Register" then
        if data.Sender and data.Color then
            registerPlayer(data.Sender, data.Color)
            GGHPlayers[data.Sender] = data.Color
            updatePlayersList()
        end
    elseif action == "GGH_Leave" then
        if data.Sender then
            removePlayer(data.Sender)
        end
    elseif action == "GGH_Clear" then
        if data.Sender == Player.Name then
            clearChat()
        end
    end
end)

GGHRemoteFunction.OnClientInvoke = function(action, data)
    if action == "GGH_Check" then
        return {
            Name = Player.Name,
            Color = myColor,
            UserId = Player.UserId,
            Version = "2.0",
            Active = true
        }
    elseif action == "GGH_GetPlayers" then
        local players = {}
        for name, color in pairs(GGHPlayers) do
            table.insert(players, {
                Name = name,
                Color = color
            })
        end
        return players
    end
    return nil
end

-- Привязка кнопок
SendButton.MouseButton1Click:Connect(function()
    sendChatMessage(ChatInput.Text)
end)

ChatInput.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        sendChatMessage(ChatInput.Text)
    end
end)

MinimizeBtn.MouseButton1Click:Connect(toggleMinimize)
MinimizedButton.MouseButton1Click:Connect(toggleMinimize)

SettingsBtn.MouseButton1Click:Connect(function()
    togglePlayersPanel()
end)

CloseBtn.MouseButton1Click:Connect(function()
    pcall(function()
        GGHRemoteEvent:FireServer("GGH_Leave", {
            Sender = Player.Name,
            UserId = Player.UserId
        })
    end)
    
    TweenService:Create(MainContainer, TweenInfo.new(0.3), {
        Size = UDim2.new(0, 0, 0, 0),
        Position = MainContainer.Position + UDim2.new(0, 300, 0, 250)
    }):Play()
    
    wait(0.3)
    ScreenGui:Destroy()
end)

-- Горячие клавиши
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == Enum.KeyCode.Slash then
            ChatInput:CaptureFocus()
        elseif input.KeyCode == Enum.KeyCode.Escape then
            ChatInput:ReleaseFocus()
        elseif input.KeyCode == Enum.KeyCode.L and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            clearChat()
        elseif input.KeyCode == Enum.KeyCode.M and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            toggleMinimize()
        elseif input.KeyCode == Enum.KeyCode.P and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            togglePlayersPanel()
        elseif input.KeyCode == Enum.KeyCode.T and UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
            -- Тестовое сообщение
            sendChatMessage("Тестовое сообщение от GGH Chat")
        end
    end
end)

-- Инициализация
addMessageToChat("SYSTEM", "GGH Chat v2.0 успешно активирован!", true)
addMessageToChat("SYSTEM", "Добро пожаловать в приватный чат для Lua эксплойтеров!", true)
addMessageToChat("SYSTEM", "Горячие клавиши: / - чат, Ctrl+L - очистить, Ctrl+M - свернуть", true)
addMessageToChat("SYSTEM", "Ctrl+P - панель игроков, Ctrl+T - тестовое сообщение", true)

-- Регистрация себя
spawn(function()
    wait(1)
    pcall(function()
        GGHRemoteEvent:FireServer("GGH_Register", {
            Sender = Player.Name,
            Color = myColor,
            UserId = Player.UserId,
            Version = "2.0"
        })
    end)
    
    -- Тестовые сообщения
    wait(2)
    addMessageToChat("GGH BOT", "Чат работает в стабильном режиме", false, ColorScheme.Success)
    wait(1)
    addMessageToChat("GGH BOT", "Подключено к сети GGH", false, ColorScheme.Success)
end)

-- Периодическая проверка соединения
spawn(function()
    while wait(30) and ScreenGui.Parent do
        pcall(function()
            GGHRemoteEvent:FireServer("GGH_Ping", {
                Sender = Player.Name,
                Timestamp = os.time()
            })
        end)
    end
end)

print("========================================")
print("GGH Chat v2.0 успешно загружен!")
print("Ваш цвет: " .. tostring(myColor))
print("Горячие клавиши:")
print("/ - фокус на чат")
print("Ctrl+L - очистить чат")
print("Ctrl+M - свернуть/развернуть")
print("Ctrl+P - скрыть/показать список игроков")
print("Ctrl+T - тестовое сообщение")
print("========================================")
