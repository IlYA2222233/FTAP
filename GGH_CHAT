-- GGH PROTECTION v1.0 - Антикик, антиграб, античат кик, невизуальная защита

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- НАСТРОЙКИ ЗАЩИТЫ
local PROTECTION_SETTINGS = {
    AntiKick = true,           -- Защита от киков
    AntiGrab = true,           -- Защита от граба
    AntiChatKick = true,       -- Защита от кика через чат
    AntiTeleport = true,       -- Защита от телепортов
    AntiVoid = true,           -- Защита от выкидывания в бездну
    AntiFling = true,          -- Защита от флинга
    AntiStun = true,           -- Защита от стан-атак
    AntiFreeze = true,         -- Защита от заморозки
    AntiToolSteal = true,      -- Защита от кражи инструментов
    AntiCharacterReset = true, -- Защита от сброса персонажа
    SilentMode = true,         -- Невидимый режим
    AutoRespawn = true         -- Авто-респавн при смерти
}

-- ГЛОБАЛЬНАЯ ЗАЩИТА
local originalFunctions = {}
local protectedProperties = {}
local backupCFrame = HumanoidRootPart.CFrame
local lastSafePosition = HumanoidRootPart.CFrame
local isProtected = true
local protectionThread = nil
local detectedAttacks = {}

-- СИСТЕМА ЛОГИРОВАНИЯ
local function logAttack(attackType, attacker)
    local timestamp = os.date("%H:%M:%S")
    local logMessage = string.format("[%s] Обнаружена атака: %s", timestamp, attackType)
    if attacker then
        logMessage = logMessage .. string.format(" от %s", attacker)
    end
    print(logMessage)
    table.insert(detectedAttacks, {time = tick(), type = attackType, attacker = attacker})
end

-- ЗАЩИТА ОТ КИКОВ
if PROTECTION_SETTINGS.AntiKick then
    -- Перехват функции Kick
    local mt = getrawmetatable(game)
    local originalIndex = mt.__index
    setreadonly(mt, false)
    
    mt.__index = newcclosure(function(self, key)
        if key == "Kick" or key == "kick" then
            logAttack("Попытка кика", tostring(self))
            return function() 
                print("GGH: Защита от кика активирована")
                return nil
            end
        end
        return originalIndex(self, key)
    end)
    
    setreadonly(mt, true)
    
    -- Защита от сетевых киков
    for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
        if obj:IsA("RemoteEvent") and (obj.Name:lower():find("kick") or obj.Name:lower():find("ban")) then
            pcall(function()
                obj.OnClientEvent:Connect(function(...)
                    logAttack("Сетевой кик через " .. obj.Name)
                end)
            end)
        end
    end
    
    print("GGH: Антикик активирован")
end

-- ЗАЩИТА ОТ ГРАБА (ANTI-GRAB)
if PROTECTION_SETTINGS.AntiGrab then
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiGrab do
            wait(0.1)
            
            -- Проверка на необычное движение
            local currentVelocity = HumanoidRootPart.Velocity
            local speed = currentVelocity.Magnitude
            
            if speed > 500 then -- Слишком высокая скорость
                HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                HumanoidRootPart.CFrame = lastSafePosition
                logAttack("Попытка граба (высокая скорость)")
            end
            
            -- Проверка на телепортацию
            local distance = (HumanoidRootPart.Position - lastSafePosition.Position).Magnitude
            if distance > 1000 then -- Слишком далеко телепортировали
                HumanoidRootPart.CFrame = lastSafePosition
                logAttack("Попытка телепортации грабом")
            end
            
            -- Сохраняем безопасную позицию
            if speed < 50 and distance < 100 then
                lastSafePosition = HumanoidRootPart.CFrame
            end
            
            -- Защита от сетевых грабов
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= Player then
                    pcall(function()
                        local char = player.Character
                        if char and char:FindFirstChild("HumanoidRootPart") then
                            local distanceToPlayer = (HumanoidRootPart.Position - char.HumanoidRootPart.Position).Magnitude
                            if distanceToPlayer < 5 then
                                -- Отталкивание при слишком близком подходе
                                local direction = (HumanoidRootPart.Position - char.HumanoidRootPart.Position).Unit
                                HumanoidRootPart.Velocity = direction * 20
                            end
                        end
                    end)
                end
            end
        end
    end)
    
    print("GGH: Антиграб активирован")
end

-- ЗАЩИТА ОТ ЧАТ КИКОВ
if PROTECTION_SETTINGS.AntiChatKick then
    -- Мониторинг чата
    local function monitorChat()
        pcall(function()
            local chatEvents = {}
            
            -- Поиск чат-ивентов
            for _, obj in pairs(ReplicatedStorage:GetDescendants()) do
                if obj:IsA("RemoteEvent") and (obj.Name:lower():find("chat") or obj.Name:lower():find("message")) then
                    table.insert(chatEvents, obj)
                end
            end
            
            for _, event in pairs(chatEvents) do
                event.OnClientEvent:Connect(function(...)
                    local args = {...}
                    if args and #args > 0 then
                        local message = tostring(args[1]):lower()
                        
                        -- Детектирование вредоносных команд
                        local maliciousPatterns = {
                            "kick me", "ban me", "crash me", "lag me",
                            "kill me", "reset me", "teleport me", "void me",
                            "exploit", "hack", "cheat"
                        }
                        
                        for _, pattern in pairs(maliciousPatterns) do
                            if message:find(pattern) then
                                logAttack("Чат кик: " .. message)
                                -- Блокируем выполнение
                                return nil
                            end
                        end
                    end
                end)
            end
        end)
    end
    
    spawn(monitorChat)
    print("GGH: Защита от чат-киков активирована")
end

-- ЗАЩИТА ОТ ТЕЛЕПОРТОВ
if PROTECTION_SETTINGS.AntiTeleport then
    local lastValidPosition = HumanoidRootPart.CFrame
    local teleportDetectionCount = 0
    
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiTeleport do
            wait(0.5)
            
            local currentPos = HumanoidRootPart.Position
            local distance = (currentPos - lastValidPosition.Position).Magnitude
            
            if distance > 500 then -- Внезапная телепортация
                teleportDetectionCount = teleportDetectionCount + 1
                
                if teleportDetectionCount > 2 then
                    HumanoidRootPart.CFrame = lastValidPosition
                    logAttack("Телепорт в небезопасную зону")
                    teleportDetectionCount = 0
                end
            else
                lastValidPosition = HumanoidRootPart.CFrame
                teleportDetectionCount = 0
            end
            
            -- Защита от телепорт-тулов
            for _, tool in pairs(Character:GetChildren()) do
                if tool:IsA("Tool") then
                    pcall(function()
                        for _, event in pairs(tool:GetDescendants()) do
                            if event:IsA("RemoteEvent") then
                                event.OnClientEvent:Connect(function(...)
                                    logAttack("Телепорт через инструмент: " .. tool.Name)
                                    -- Отменяем телепорт
                                    return nil
                                end)
                            end
                        end
                    end)
                end
            end
        end
    end)
    
    print("GGH: Антителепорт активирован")
end

-- ЗАЩИТА ОТ БЕЗДНЫ (ANTI-VOID)
if PROTECTION_SETTINGS.AntiVoid then
    local voidYLevel = -500
    local respawnYLevel = -100
    
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiVoid do
            wait(0.3)
            
            if HumanoidRootPart.Position.Y < voidYLevel then
                -- Телепортируем на безопасную позицию
                local safeSpot = CFrame.new(0, 50, 0)
                
                -- Ищем спавн-точку
                local spawns = Workspace:FindFirstChild("SpawnLocation")
                if spawns then
                    safeSpot = spawns.CFrame + Vector3.new(0, 5, 0)
                end
                
                HumanoidRootPart.CFrame = safeSpot
                HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                logAttack("Спасение из бездны")
            end
        end
    end)
    
    print("GGH: Анти-бездна активирован")
end

-- ЗАЩИТА ОТ ФЛИНГА (ANTI-FLING)
if PROTECTION_SETTINGS.AntiFling then
    local maxVelocity = 150
    local flingDetectionCount = 0
    
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiFling do
            wait(0.1)
            
            local velocity = HumanoidRootPart.Velocity.Magnitude
            
            if velocity > maxVelocity then
                flingDetectionCount = flingDetectionCount + 1
                
                if flingDetectionCount > 3 then
                    -- Сбрасываем скорость и позицию
                    HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                    HumanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
                    HumanoidRootPart.CFrame = lastSafePosition
                    
                    logAttack("Атака флингом (скорость: " .. math.floor(velocity) .. ")")
                    flingDetectionCount = 0
                end
            else
                flingDetectionCount = 0
            end
            
            -- Сохраняем безопасную позицию когда стоим
            if velocity < 10 then
                lastSafePosition = HumanoidRootPart.CFrame
            end
        end
    end)
    
    print("GGH: Антифлинг активирован")
end

-- ЗАЩИТА ОТ СТАНА (ANTI-STUN)
if PROTECTION_SETTINGS.AntiStun then
    local humanoid = Character:WaitForChild("Humanoid")
    local originalWalkSpeed = humanoid.WalkSpeed
    local originalJumpPower = humanoid.JumpPower
    
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiStun do
            wait(0.2)
            
            -- Восстанавливаем параметры если их изменили
            if humanoid.WalkSpeed < originalWalkSpeed * 0.5 then
                humanoid.WalkSpeed = originalWalkSpeed
                logAttack("Восстановление скорости")
            end
            
            if humanoid.JumpPower < originalJumpPower * 0.5 then
                humanoid.JumpPower = originalJumpPower
                logAttack("Восстановление прыжка")
            end
            
            -- Защита от сетевых стан-атак
            for _, connection in pairs(getconnections(humanoid.StateChanged)) do
                pcall(function()
                    connection:Disable()
                end)
            end
        end
    end)
    
    print("GGH: Антистан активирован")
end

-- ЗАЩИТА ОТ ЗАМОРОЗКИ (ANTI-FREEZE)
if PROTECTION_SETTINGS.AntiFreeze then
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiFreeze do
            wait(0.5)
            
            -- Проверка на заморозку анимаций
            pcall(function()
                local animator = Character:FindFirstChildOfClass("Animator")
                if animator then
                    for _, track in pairs(animator:GetPlayingAnimationTracks()) do
                        if track.IsPlaying and track.WeightCurrent > 0.9 then
                            -- Сбрасываем слишком доминирующие анимации
                            track:Stop(0.1)
                        end
                    end
                end
            end)
            
            -- Защита от физической заморозки
            for _, part in pairs(Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    if part.Anchored then
                        part.Anchored = false
                        logAttack("Разблокировка замороженной части: " .. part.Name)
                    end
                    
                    if part.Massless then
                        part.Massless = false
                    end
                end
            end
        end
    end)
    
    print("GGH: Антифриз активирован")
end

-- ЗАЩИТА ОТ КРАЖИ ИНСТРУМЕНТОВ
if PROTECTION_SETTINGS.AntiToolSteal then
    local originalTools = {}
    
    -- Делаем резервную копию инструментов
    for _, tool in pairs(Character:GetChildren()) do
        if tool:IsA("Tool") then
            originalTools[tool.Name] = tool:Clone()
        end
    end
    
    spawn(function()
        while isProtected and PROTECTION_SETTINGS.AntiToolSteal do
            wait(1)
            
            -- Проверяем наличие инструментов
            local currentTools = {}
            for _, tool in pairs(Character:GetChildren()) do
                if tool:IsA("Tool") then
                    currentTools[tool.Name] = true
                end
            end
            
            -- Восстанавливаем потерянные инструменты
            for toolName, toolCopy in pairs(originalTools) do
                if not currentTools[toolName] then
                    local newTool = toolCopy:Clone()
                    newTool.Parent = Character
                    logAttack("Восстановлен инструмент: " .. toolName)
                end
            end
            
            -- Защита от сетевого удаления инструментов
            for _, tool in pairs(Character:GetChildren()) do
                if tool:IsA("Tool") then
                    pcall(function()
                        tool.Destroying:Connect(function()
                            logAttack("Попытка удаления инструмента: " .. tool.Name)
                            task.wait(0.1)
                            if not tool.Parent then
                                local restored = originalTools[tool.Name]
                                if restored then
                                    restored:Clone().Parent = Character
                                end
                            end
                        end)
                    end)
                end
            end
        end
    end)
    
    print("GGH: Защита инструментов активирована")
end

-- ЗАЩИТА ОТ СБРОСА ПЕРСОНАЖА
if PROTECTION_SETTINGS.AntiCharacterReset then
    -- Отключаем стандартный сброс
    pcall(function()
        local humanoid = Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.BreakJointsOnDeath = false
        end
    end)
    
    -- Перехват функции сброса
    local function preventCharacterReset()
        pcall(function()
            -- Защита от сетевых сбросов
            for _, event in pairs(ReplicatedStorage:GetDescendants()) do
                if event:IsA("RemoteEvent") and (
                    event.Name:lower():find("reset") or 
                    event.Name:lower():find("death") or
                    event.Name:lower():find("kill")
                ) then
                    event.OnClientEvent:Connect(function(...)
                        logAttack("Сетевой сброс через: " .. event.Name)
                        return nil
                    end)
                end
            end
        end)
    end
    
    spawn(preventCharacterReset)
    
    -- Защита при смерти
    if PROTECTION_SETTINGS.AutoRespawn then
        Character:WaitForChild("Humanoid").Died:Connect(function()
            logAttack("Персонаж умер, восстановление...")
            task.wait(2)
            
            -- Телепортируем на спавн
            local spawnLocation = Workspace:FindFirstChild("SpawnLocation") or Workspace:FindFirstChild("Spawn")
            if spawnLocation then
                HumanoidRootPart.CFrame = spawnLocation.CFrame + Vector3.new(0, 5, 0)
            else
                HumanoidRootPart.CFrame = CFrame.new(0, 50, 0)
            end
            
            -- Восстанавливаем здоровье
            local humanoid = Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.Health = humanoid.MaxHealth
            end
        end)
    end
    
    print("GGH: Защита от сброса персонажа активирована")
end

-- НЕВИДИМЫЙ РЕЖИМ
if PROTECTION_SETTINGS.SilentMode then
    -- Скрываем интерфейс защиты
    local function hideProtection()
        -- Скрываем сообщения в выводе
        local oldPrint = print
        print = function(...)
            -- Показываем только важные сообщения
            local args = {...}
            local msg = tostring(args[1])
            if msg:find("GGH:") or msg:find("Обнаружена атака:") then
                oldPrint(...)
            end
        end
        
        -- Минимальная видимость в F9
        print("\n========================================")
        print("GGH PROTECTION v1.0 - ACTIVE")
        print("Защита работает в скрытом режиме")
        print("========================================\n")
    end
    
    hideProtection()
    
    print("GGH: Скрытый режим активирован")
end

-- СИСТЕМА ВОССТАНОВЛЕНИЯ
local function setupRecoverySystem()
    -- Резервное копирование позиции
    spawn(function()
        while isProtected do
            wait(5)
            backupCFrame = HumanoidRootPart.CFrame
        end
    end)
    
    -- Авто-восстановление при проблемах
    spawn(function()
        while isProtected do
            wait(10)
            
            -- Проверяем целостность персонажа
            if not Character or not Character.Parent then
                logAttack("Персонаж потерян, восстановление...")
                
                -- Пересоздаем связь с персонажем
                Character = Player.Character or Player.CharacterAdded:Wait()
                HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
                HumanoidRootPart.CFrame = backupCFrame
            end
            
            -- Проверяем подключение к серверу
            if not Players:FindFirstChild(Player.Name) then
                logAttack("Потеряно подключение к серверу")
            end
        end
    end)
end

setupRecoverySystem()

-- ФУНКЦИИ УПРАВЛЕНИЯ
local GGH_Protection = {
    -- Включить/выключить защиту
    ToggleProtection = function(state)
        isProtected = state
        print("GGH: Защита " .. (state and "включена" or "выключена"))
    end,
    
    -- Получить статус защиты
    GetStatus = function()
        return {
            Protected = isProtected,
            AttacksDetected = #detectedAttacks,
            LastAttack = detectedAttacks[#detectedAttacks] or "Нет атак",
            Settings = PROTECTION_SETTINGS
        }
    end,
    
    -- Восстановить позицию
    RestorePosition = function()
        HumanoidRootPart.CFrame = backupCFrame
        HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
        print("GGH: Позиция восстановлена")
    end,
    
    -- Очистить историю атак
    ClearAttackLog = function()
        detectedAttacks = {}
        print("GGH: История атак очищена")
    end
}

-- АВТОМАТИЧЕСКАЯ АКТИВАЦИЯ
print("\n" .. string.rep("=", 50))
print("GGH PROTECTION SYSTEM v1.0")
print("Защита активирована: " .. Player.Name)
print("Статус: АКТИВНО")
print(string.rep("=", 50) .. "\n")

-- ВОЗВРАЩАЕМ УПРАВЛЕНИЕ
return GGH_Protection
